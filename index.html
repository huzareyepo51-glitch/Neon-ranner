<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ff0055">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <title>NEON RUNNER</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f0ff; --neon-pink: #ff0055; }
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* –ó–ê–°–¢–ê–í–ö–ê (LANDING) */
        #landing-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0000 0%, #000 80%);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-image: linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .logo {
            font-size: 3.5rem; line-height: 0.9; margin-bottom: 50px; color: #fff;
            text-transform: uppercase; text-shadow: 0 0 20px var(--neon-pink);
            font-weight: 900; letter-spacing: 2px; text-align: center;
            animation: float 4s ease-in-out infinite;
        }
        .logo span { color: var(--neon-blue); font-size: 0.5em; letter-spacing: 8px; display: block; margin-top: 5px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 18px 40px; border-radius: 12px; font-weight: 900; font-size: 1.2rem;
            text-transform: uppercase; border: none; cursor: pointer; margin: 10px;
            width: 85%; max-width: 320px; transition: all 0.2s; position: relative;
        }

        /* –ö–Ω–æ–ø–∫–∞ –£–°–¢–ê–ù–û–í–ò–¢–¨ (–°–∞–º–∞—è —è—Ä–∫–∞—è) */
        #btn-install {
            background: var(--neon-blue); color: #000;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
            display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            animation: pulse-glow 2s infinite;
        }
        #btn-install:active { transform: scale(0.95); }

        /* –ö–Ω–æ–ø–∫–∞ –ò–ì–†–ê–¢–¨ (–û–±—ã—á–Ω–∞—è) */
        #btn-play {
            background: transparent; border: 2px solid #333; color: #888;
            opacity: 0; animation: fadeIn 1s forwards 0.5s; /* –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–ª–∞–≤–Ω–æ */
        }
        #btn-play:hover { border-color: #fff; color: #fff; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #game-ui { display: none; }
        #ui { position: absolute; top: env(safe-area-inset-top, 20px); left: 20px; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); pointer-events: none; z-index: 10; }
        #score-board { font-size: 2rem; font-weight: 800; }
        #stats { font-size: 1rem; opacity: 0.8; color: #fff; margin-top: 5px; }
        #boss-warning { position: absolute; top: 15%; width: 100%; text-align: center; font-size: 2rem; color: #ff0000; text-shadow: 0 0 20px #ff0000; display: none; z-index: 15; background: rgba(0,0,0,0.7); padding: 15px 0; animation: blink 0.5s infinite; }
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; background: rgba(10, 0, 20, 0.95); padding: 40px; border: 2px solid var(--neon-pink); color: #fff; width: 85%; max-width: 400px; box-shadow: 0 0 50px var(--neon-pink); clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
        .restart-btn { background: var(--neon-pink); border: none; color: #fff; padding: 15px; width: 100%; font-weight: 900; font-size: 1.2rem; margin-top: 20px; text-transform: uppercase; }
        
        canvas { display: block; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); } 50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.6); } 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- –ó–ê–°–¢–ê–í–ö–ê -->
    <div id="landing-screen">
        <div class="logo">NEON<br>RUNNER<span>ULTIMATE</span></div>
        
        <!-- –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è, –µ—Å–ª–∏ Android —Ä–∞–∑—Ä–µ—à–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É -->
        <button id="btn-install" class="btn">üì≤ –£–°–¢–ê–ù–û–í–ò–¢–¨ APP</button>
        
        <!-- –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞ -->
        <button id="btn-play" class="btn" onclick="startGame()">‚ñ∂ –ò–ì–†–ê–¢–¨ –í –ë–†–ê–£–ó–ï–†–ï</button>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="game-ui">
        <div id="ui">
            <div id="score-board">SCORE: 0000</div>
            <div id="stats">SPD: <span id="val-speed">0.0</span> | CREDITS: <span id="val-chips">0</span></div>
        </div>
        <div id="boss-warning">‚ö† ADAM SMASHER DETECTED ‚ö†</div>
        <div id="game-over">
            <h1 style="color: var(--neon-pink); margin: 0; font-size: 2.5rem;">FLATLINED</h1>
            <p style="font-size: 1.2rem; margin: 15px 0;">–§–ò–ù–ê–õ–¨–ù–´–ô –°–ß–ï–¢: <span id="final-score">0</span></p>
            <button class="restart-btn" onclick="location.reload()">REBOOT SYSTEM</button>
        </div>
    </div>

    <script>
        // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        let deferredPrompt;
        const installBtn = document.getElementById('btn-install');
        const playBtn = document.getElementById('btn-play');
        const landing = document.getElementById('landing-screen');
        const gameUI = document.getElementById('game-ui');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ —É–∂–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        if (isStandalone) {
            startGame(); // –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –±–µ–∑ –∑–∞—Å—Ç–∞–≤–∫–∏
        }

        // –õ–æ–≤–∏–º —Å–æ–±—ã—Ç–∏–µ "–ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            playBtn.style.borderColor = '#333'; // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –∏–≥—Ä—ã –º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω–æ–π
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none';
                }
            }
        });

        function startGame() {
            landing.style.display = 'none';
            gameUI.style.display = 'block';
            initThreeJS(); // –ó–∞–ø—É—Å–∫ 3D
        }

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        // --- –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö (THREE.JS) ---
        let scene, camera, renderer, player, clock;
        let obstacles = [], coins = [], lasers = [], sparks = [];
        let score = 0, chipsCount = 0, speed = 0.5, gameActive = true;
        let velocityY = 0;
        const gravity = -0.015, jumpStrength = 0.35, laneWidth = 4;
        let boss, bossActive = false, bossTimer = 0;
        let touchStartX = 0;

        const playerBox = new THREE.Box3();
        const entityBox = new THREE.Box3();

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, 11);
            camera.lookAt(0, 2, -10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // –°–≤–µ—Ç
            scene.add(new THREE.AmbientLight(0x404040));
            const pLight = new THREE.PointLight(0x00f0ff, 2, 50);
            pLight.position.set(0, 10, 5);
            scene.add(pLight);

            createPlayer();
            createEnvironment();
            createBoss();

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            window.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX, {passive: false});
            window.addEventListener('touchend', e => {
                const diffX = e.changedTouches[0].clientX - touchStartX;
                if (Math.abs(diffX) < 25) {
                    if (player.position.y <= 0.31) velocityY = jumpStrength;
                } else {
                    if (diffX > 30 && player.position.x < laneWidth) { player.position.x += laneWidth; createSparks(); }
                    if (diffX < -30 && player.position.x > -laneWidth) { player.position.x -= laneWidth; createSparks(); }
                }
            }, {passive: false});

            window.addEventListener('resize', onResize);
            animate();
        }

        // ... [–ö–û–î –°–û–ó–î–ê–ù–ò–Ø –û–ë–™–ï–ö–¢–û–í - –¢–ê–ö–û–ô –ñ–ï –ö–ê–ö –í –ü–†–û–®–õ–û–ô –í–ï–†–°–ò–ò] ...
        function createPlayer() {
            player = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({ color: 0x111111, emissive: 0x00f0ff, emissiveIntensity: 0.3 });
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.6, 3), mat); body.position.y = 0.3; player.add(body);
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.5, 1.2), new THREE.MeshPhongMaterial({ color: 0x000000 })); cabin.position.set(0, 0.7, -0.2); player.add(cabin);
            scene.add(player);
        }

        function createEnvironment() {
            const grid = new THREE.GridHelper(400, 80, 0xff0055, 0x220011); grid.position.z = -50; scene.add(grid);
        }

        function createBoss() {
            boss = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({ color: 0x1a1a1a, emissive: 0x330000 });
            const hull = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 7), mat); boss.add(hull);
            const smasher = new THREE.Group();
            const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 0.8), mat); torso.position.y = 1.7; smasher.add(torso);
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), mat); head.position.y = 2.8; smasher.add(head);
            const eye = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ color: 0xff0000 })); eye.position.set(0, 0, 0.3); head.add(eye);
            smasher.position.y = 0.5; boss.add(smasher);
            boss.position.set(0, 6, -180); boss.rotation.y = Math.PI; scene.add(boss);
        }

        function spawnEntity() {
            const lane = [-laneWidth, 0, laneWidth][Math.floor(Math.random() * 3)];
            if (Math.random() < 0.65) {
                const h = Math.random() * 2 + 1;
                const obs = new THREE.Mesh(new THREE.BoxGeometry(3, h, 1), new THREE.MeshPhongMaterial({ color: 0xff0055 }));
                obs.position.set(lane, h/2, -100); scene.add(obs); obstacles.push(obs);
            } else {
                const coin = new THREE.Mesh(new THREE.SphereGeometry(0.5, 12, 12), new THREE.MeshBasicMaterial({ color: 0xfcee0a }));
                coin.position.set(lane, 1.0, -100); scene.add(coin); coins.push(coin);
            }
        }

        function spawnLaser() {
            const laser = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 8), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            laser.rotation.x = Math.PI / 2; laser.position.set(player.position.x, 0.4, boss.position.z + 5);
            scene.add(laser); lasers.push(laser);
        }

        function createSparks() {
            for(let i=0; i<8; i++) {
                const spark = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), new THREE.MeshBasicMaterial({ color: 0x00f0ff }));
                spark.position.set(player.position.x, 0.1, 1);
                spark.userData = { vx: (Math.random()-0.5)*0.2, vy: Math.random()*0.2, life: 1.0 };
                scene.add(spark); sparks.push(spark);
            }
        }

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            speed += 0.0001;

            player.position.y += velocityY;
            if (player.position.y > 0.3) velocityY += gravity; else { player.position.y = 0.3; velocityY = 0; }

            for(let i = sparks.length - 1; i >= 0; i--) {
                const s = sparks[i]; s.position.x += s.userData.vx; s.position.y += s.userData.vy;
                s.userData.life -= 0.04; s.scale.setScalar(s.userData.life);
                if(s.userData.life <= 0) { scene.remove(s); sparks.splice(i, 1); }
            }

            if (score > 200) {
                if (!bossActive) {
                    bossActive = true;
                    document.getElementById('boss-warning').style.display = 'block';
                    setTimeout(() => document.getElementById('boss-warning').style.display = 'none', 3500);
                }
                boss.position.z = THREE.MathUtils.lerp(boss.position.z, -30, 0.04);
                boss.position.x = THREE.MathUtils.lerp(boss.position.x, player.position.x, 0.05);
                bossTimer += delta;
                if (bossTimer > 2.0) { spawnLaser(); bossTimer = 0; }
            }

            lasers.forEach((l, i) => {
                l.position.z += (speed * 60 + 25) * delta;
                playerBox.setFromObject(player); entityBox.setFromObject(l);
                if (playerBox.intersectsBox(entityBox)) gameOver();
                if (l.position.z > 20) { scene.remove(l); lasers.splice(i, 1); }
            });

            obstacles.forEach((obs, i) => {
                obs.position.z += speed * 95 * delta;
                playerBox.setFromObject(player); entityBox.setFromObject(obs);
                if (playerBox.intersectsBox(entityBox)) gameOver();
                if (obs.position.z > 15) { scene.remove(obs); obstacles.splice(i, 1); score += 10; updateUI(); }
            });

            coins.forEach((c, i) => {
                c.position.z += speed * 95 * delta;
                if (Math.abs(player.position.z - c.position.z) < 1.5 && Math.abs(player.position.x - c.position.x) < 1.2) {
                    scene.remove(c); coins.splice(i, 1); chipsCount++; score += 50; updateUI();
                }
                if (c.position.z > 15) { scene.remove(c); coins.splice(i, 1); }
            });

            if (Math.random() < 0.04) spawnEntity();
            renderer.render(scene, camera);
        }

        function updateUI() { document.getElementById('score-board').textContent = `SCORE: ${score.toString().padStart(4, '0')}`; document.getElementById('val-speed').textContent = (speed * 10).toFixed(1); document.getElementById('val-chips').textContent = chipsCount; }
        function gameOver() { gameActive = false; document.getElementById('game-over').style.display = 'block'; document.getElementById('final-score').textContent = score; if (navigator.vibrate) navigator.vibrate([100, 50, 100]); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
    </script>
</body>
</html>
